<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B3L5 Mind the Gap - ä¸‰éšæ®µé—–é—œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', 'Nunito', sans-serif; touch-action: manipulation; background-color: #f0f9ff; }
        .pulse-ring { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* åŠ å¼·é¸ä¸­æ•ˆæœï¼šæ·±è‰²é‚Šæ¡† + æ˜é¡¯åº•è‰² */
        .card-selected { 
            border-color: #4338ca !important; /* Indigo-700 */
            background-color: #c7d2fe !important; /* Indigo-200 */
            border-width: 3px !important;
            transform: scale(0.98);
        }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        /* Progress Bar Transition */
        .progress-bar { transition: width 1s linear; }
    </style>
</head>
<body class="h-screen flex flex-col items-center overflow-hidden bg-gradient-to-br from-blue-50 to-indigo-100">

    <!-- APP CONTAINER -->
    <div id="app" class="w-full max-w-md h-full bg-white shadow-xl relative overflow-hidden sm:rounded-xl sm:h-[95vh] sm:my-4 sm:border-4 sm:border-indigo-200 flex flex-col">
        
        <!-- HEADER -->
        <div class="bg-indigo-600 text-white p-4 z-20 shadow-md flex justify-between items-center shrink-0">
            <h1 class="font-bold text-lg"><i class="fas fa-subway mr-2"></i>Mind the Gap</h1>
            <div class="flex items-center space-x-2">
                <span id="level-badge" class="text-xs bg-indigo-800 px-2 py-1 rounded-full hidden">Level 1</span>
                <span id="score-display" class="font-mono font-bold hidden">0%</span>
            </div>
        </div>

        <!-- CONTENT AREA (Scrollable) -->
        <div id="main-content" class="flex-1 relative overflow-y-auto overflow-x-hidden">
            
            <!-- VIEW: START -->
            <div id="view-start" class="h-full flex flex-col justify-center items-center p-8 space-y-6">
                <div class="text-center space-y-2">
                    <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2 text-4xl">ğŸ‡¬ğŸ‡§</div>
                    <h2 class="text-2xl font-bold text-gray-800">ä¸‰éšæ®µå–®å­—é—–é—œ</h2>
                    <p class="text-gray-500 text-sm">B3L5: Mind the Gap</p>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-xl w-full text-sm space-y-2">
                    <h3 class="font-bold text-indigo-700 mb-2">é—œå¡èªªæ˜ï¼š</h3>
                    <p>1ï¸âƒ£ <span class="font-bold">è½éŸ³è¾¨ç¾©</span>ï¼šè½ç™¼éŸ³é¸ä¸­æ–‡ (å…¨å–®å­—)</p>
                    <p>2ï¸âƒ£ <span class="font-bold">ä¸­è‹±é…å°</span>ï¼šé™æ™‚90ç§’ (éš¨æ©Ÿ10é¡Œ)</p>
                    <p>3ï¸âƒ£ <span class="font-bold">èªéŸ³è¾¨è­˜</span>ï¼šé–‹å£èªªè‹±æ–‡ (éš¨æ©Ÿ10é¡Œ)</p>
                    <p class="text-red-500 text-xs mt-2 border-t border-blue-200 pt-2 font-bold">âš ï¸ æ¯é—œæ­£ç¢ºç‡é ˆé” 80% æ‰èƒ½æ™‰ç´šï¼</p>
                </div>

                <div class="w-full space-y-3">
                    <input type="text" id="username-input" placeholder="è«‹è¼¸å…¥å§“å / åº§è™Ÿ" class="w-full p-3 border-2 border-indigo-200 rounded-xl text-center focus:outline-none focus:border-indigo-500">
                    <button onclick="startGame()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">
                        é–‹å§‹æŒ‘æˆ°
                    </button>
                </div>
            </div>

            <!-- VIEW: LEVEL INTRO (Transition) -->
            <div id="view-intro" class="h-full flex flex-col justify-center items-center p-8 hidden bg-indigo-900 text-white z-30 absolute top-0 left-0 w-full">
                <div class="text-center animate-bounce">
                    <i id="intro-icon" class="fas fa-headphones-alt text-6xl mb-4"></i>
                    <h2 id="intro-title" class="text-3xl font-bold mb-2">Level 1</h2>
                    <p id="intro-desc" class="text-indigo-200 text-lg">è½éŸ³è¾¨ç¾©</p>
                </div>
                <button onclick="startLevelActual()" class="mt-12 bg-white text-indigo-900 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 active:scale-95">
                    æº–å‚™å¥½äº†ï¼GO
                </button>
            </div>

            <!-- VIEW: LEVEL 1 (Listening) -->
            <div id="view-level1" class="h-full flex flex-col p-6 hidden">
                <div class="flex-1 flex flex-col justify-center items-center space-y-8">
                    <!-- Progress -->
                    <div class="w-full h-2 bg-gray-200 rounded-full mb-4">
                        <div id="l1-progress" class="h-full bg-indigo-500 rounded-full" style="width: 0%"></div>
                    </div>

                    <!-- Audio Button -->
                    <button onclick="playL1Audio()" class="w-32 h-32 rounded-full bg-indigo-100 text-indigo-600 shadow-md flex items-center justify-center active:scale-95 transition hover:bg-indigo-200">
                        <i class="fas fa-volume-up text-5xl"></i>
                    </button>
                    <p class="text-gray-400 text-sm">é»æ“Šæ’­æ”¾è²éŸ³</p>

                    <!-- Options -->
                    <div id="l1-options" class="w-full grid grid-cols-1 gap-3">
                        <!-- Options injected by JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: LEVEL 2 (Matching) -->
            <div id="view-level2" class="h-full flex flex-col hidden relative">
                <!-- Timer Bar -->
                <div class="w-full h-2 bg-gray-200">
                    <div id="l2-timer-bar" class="h-full bg-green-500 progress-bar" style="width: 100%"></div>
                </div>
                <div class="text-center py-2 bg-gray-50 border-b flex justify-between px-4">
                    <span class="text-sm text-gray-500">é…å°å‰©é¤˜: <span id="l2-remaining" class="font-bold text-indigo-600">10</span> çµ„</span>
                    <span class="text-sm text-gray-500">æ™‚é–“: <span id="l2-time-text" class="font-bold text-red-500">90</span>s</span>
                </div>

                <!-- Grid Container (Scrollable) -->
                <div id="l2-grid" class="flex-1 grid grid-cols-2 gap-3 p-4 content-start overflow-y-auto pb-20">
                    <!-- Cards injected by JS -->
                </div>
            </div>

            <!-- VIEW: LEVEL 3 (Speaking) -->
            <div id="view-level3" class="h-full flex flex-col p-6 hidden">
                <div class="text-center mb-6">
                     <div class="w-full h-2 bg-gray-200 rounded-full mb-2">
                        <div id="l3-progress" class="h-full bg-purple-500 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-400">Question <span id="l3-q-num">1</span> / 10</p>
                </div>

                <div class="flex-1 flex flex-col items-center justify-center space-y-6">
                    <!-- Word Card -->
                    <div class="w-full bg-white border-2 border-indigo-100 rounded-2xl shadow-lg p-6 text-center relative">
                        <p class="text-gray-400 text-sm mb-1">è«‹å”¸å‡ºé€™å€‹å­—ï¼š</p>
                        <h2 id="l3-word" class="text-4xl font-bold text-gray-800 mb-2">Passenger</h2>
                        <h3 id="l3-meaning" class="text-xl text-gray-500">ä¹˜å®¢</h3>
                        
                        <!-- Hint Button (Initially Hidden) -->
                        <button id="l3-hint-btn" onclick="playL3Hint()" class="hidden mt-4 bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full text-sm font-bold flex items-center justify-center mx-auto hover:bg-yellow-200">
                            <i class="fas fa-volume-up mr-2"></i> è½ç™¼éŸ³ (å†è©¦ä¸€æ¬¡)
                        </button>
                    </div>

                    <!-- Feedback -->
                    <div id="l3-feedback" class="h-12 flex items-center justify-center text-center">
                        <p class="text-gray-400 text-sm">è«‹æŒ‰éº¥å…‹é¢¨é–‹å§‹éŒ„éŸ³</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="mt-auto pb-8 flex justify-center">
                    <button id="l3-mic-btn" onclick="toggleL3Mic()" class="w-20 h-20 rounded-full bg-red-500 text-white shadow-xl flex items-center justify-center active:scale-95 transition text-3xl">
                        <i id="l3-mic-icon" class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>

            <!-- VIEW: RESULT / FAIL -->
            <div id="view-result" class="h-full flex flex-col justify-center items-center p-6 hidden bg-white">
                <div id="result-card" class="w-full max-w-sm bg-white rounded-2xl shadow-xl border border-gray-100 p-6 text-center">
                    
                    <div id="result-header" class="mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">é—–é—œçµæœ</h2>
                        <p id="result-user" class="text-indigo-600 font-bold">User</p>
                    </div>

                    <!-- Scores Table -->
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm font-bold text-gray-600">L1 è½éŸ³è¾¨ç¾©</span>
                            <span id="score-l1" class="font-mono font-bold text-lg text-gray-800">--%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm font-bold text-gray-600">L2 ä¸­è‹±é…å°</span>
                            <span id="score-l2" class="font-mono font-bold text-lg text-gray-800">--%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm font-bold text-gray-600">L3 èªéŸ³è¾¨è­˜</span>
                            <span id="score-l3" class="font-mono font-bold text-lg text-gray-800">--%</span>
                        </div>
                    </div>

                    <div id="result-message-box" class="bg-indigo-50 p-4 rounded-xl mb-4">
                        <p id="result-comment" class="text-indigo-800 font-bold text-sm">è©•èªè¼‰å…¥ä¸­...</p>
                    </div>

                    <!-- Action Buttons -->
                    <div id="action-buttons">
                        <!-- Injected by JS: Next Level or Screenshot or Retry -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Data & Logic -->
    <script>
        // --- 1. DATA (Expanded for 15+ items) ---
        const vocabDB = [
            { id: 1, en: "passenger", ch: "ä¹˜å®¢" },
            { id: 2, en: "platform", ch: "æœˆå°" },
            { id: 3, en: "gap", ch: "ç©ºéš™/ç¼ºå£" },
            { id: 4, en: "mind", ch: "ä»‹æ„/ç•™æ„" },
            { id: 5, en: "voice", ch: "è²éŸ³" },
            { id: 6, en: "security", ch: "å®‰å…¨/ä¿å…¨" },
            { id: 7, en: "arrive", ch: "åˆ°é”" },
            { id: 8, en: "departure", ch: "å‡ºç™¼" },
            { id: 9, en: "silence", ch: "æ²ˆé»˜" },
            { id: 10, en: "watch one's step", ch: "å°å¿ƒè…³æ­¥" },
            { id: 11, en: "station", ch: "è»Šç«™" },
            { id: 12, en: "announcement", ch: "å»£æ’­" },
            { id: 13, en: "recording", ch: "éŒ„éŸ³" },
            { id: 14, en: "husband", ch: "ä¸ˆå¤«" },
            { id: 15, en: "death", ch: "æ­»äº¡" },
            { id: 16, en: "message", ch: "è¨Šæ¯" },
            { id: 17, en: "travel", ch: "æ—…è¡Œ" }
        ];

        // --- 2. STATE ---
        let gameState = {
            user: "",
            currentLevel: 1, // 1, 2, 3
            scores: { l1: 0, l2: 0, l3: 0 }, // Percentages
            l1Data: [],
            l1Index: 0,
            l1CorrectCount: 0,
            l2Data: [],
            l2PairsLeft: 0,
            l2TimeLeft: 0,
            l2Timer: null,
            l2Selected: null,
            l2Lock: false,
            l3Data: [],
            l3Index: 0,
            l3CorrectCount: 0,
            l3MistakeMade: false
        };

        let recognition;

        // --- 3. CORE FUNCTIONS ---

        function startGame() {
            const name = document.getElementById('username-input').value.trim();
            if(!name) return alert("è«‹è¼¸å…¥å§“åï¼");
            gameState.user = name;
            gameState.currentLevel = 1;
            
            // Init Speech API early
            initSpeech();

            startLevel(1);
        }

        function startLevel(level) {
            gameState.currentLevel = level;
            
            // Show Intro Screen first
            const views = ['view-start', 'view-intro', 'view-level1', 'view-level2', 'view-level3', 'view-result'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            
            const intro = document.getElementById('view-intro');
            intro.classList.remove('hidden');
            
            const titles = ["è½éŸ³è¾¨ç¾©", "ä¸­è‹±é…å°", "èªéŸ³è¾¨è­˜"];
            const icons = ["fa-headphones-alt", "fa-puzzle-piece", "fa-microphone-alt"];
            const descs = ["è½ç™¼éŸ³é¸å‡ºæ­£ç¢ºä¸­æ–‡", "90ç§’å…§å®Œæˆé…å° (éš¨æ©Ÿ10é¡Œ)", "å¤§è²å”¸å‡ºå–®å­— (éš¨æ©Ÿ10é¡Œ)"];
            
            document.getElementById('intro-title').innerText = `Level ${level}: ${titles[level-1]}`;
            document.getElementById('intro-icon').className = `fas ${icons[level-1]} text-6xl mb-4`;
            document.getElementById('intro-desc').innerText = descs[level-1];
            
            document.getElementById('level-badge').innerText = `Level ${level}`;
            document.getElementById('level-badge').classList.remove('hidden');
        }

        function startLevelActual() {
            document.getElementById('view-intro').classList.add('hidden');
            const level = gameState.currentLevel;

            if (level === 1) initLevel1();
            else if (level === 2) initLevel2();
            else if (level === 3) initLevel3();
        }

        // --- LEVEL 1: LISTENING ---
        function initLevel1() {
            document.getElementById('view-level1').classList.remove('hidden');
            // Use ALL words for Level 1
            gameState.l1Data = shuffle([...vocabDB]);
            gameState.l1Index = 0;
            gameState.l1CorrectCount = 0;
            renderLevel1Question();
        }

        function renderLevel1Question() {
            if (gameState.l1Index >= gameState.l1Data.length) {
                endLevel1();
                return;
            }

            const current = gameState.l1Data[gameState.l1Index];
            // Progress
            const pct = (gameState.l1Index / gameState.l1Data.length) * 100;
            document.getElementById('l1-progress').style.width = `${pct}%`;

            // Auto play audio
            setTimeout(() => speak(current.en), 500);

            // Generate Options (1 Correct + 3 Wrong)
            const others = vocabDB.filter(w => w.id !== current.id);
            const wrongOptions = shuffle(others).slice(0, 3);
            const options = shuffle([current, ...wrongOptions]);

            const container = document.getElementById('l1-options');
            container.innerHTML = "";
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-white border-2 border-indigo-100 p-4 rounded-xl text-gray-700 font-bold shadow-sm hover:bg-indigo-50 active:bg-indigo-100 transition";
                btn.innerText = opt.ch;
                btn.onclick = () => checkLevel1Answer(opt.id, current.id, btn);
                container.appendChild(btn);
            });
        }

        function playL1Audio() {
            const current = gameState.l1Data[gameState.l1Index];
            speak(current.en);
        }

        function checkLevel1Answer(selectedId, correctId, btn) {
            // Disable all buttons
            const btns = document.getElementById('l1-options').children;
            for(let b of btns) b.disabled = true;

            if (selectedId === correctId) {
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                gameState.l1CorrectCount++;
                setTimeout(() => {
                    gameState.l1Index++;
                    renderLevel1Question();
                }, 800);
            } else {
                btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                // Highlight correct one
                for(let b of btns) {
                    if (b.innerText === gameState.l1Data[gameState.l1Index].ch) {
                        b.classList.add('bg-green-100', 'border-green-500');
                    }
                }
                setTimeout(() => {
                    gameState.l1Index++;
                    renderLevel1Question();
                }, 1500);
            }
        }

        function endLevel1() {
            const accuracy = Math.round((gameState.l1CorrectCount / gameState.l1Data.length) * 100);
            gameState.scores.l1 = accuracy;
            
            if (accuracy >= 80) {
                showResultScreen(true, "L1 é€šé—œï¼å‰å¾€ä¸‹ä¸€é—œ", () => startLevel(2));
            } else {
                showResultScreen(false, "L1 å¤±æ•—ï¼Œè«‹é‡è©¦", () => startLevel(1));
            }
        }

        // --- LEVEL 2: MATCHING (SPEED - MODIFIED) ---
        function initLevel2() {
            document.getElementById('view-level2').classList.remove('hidden');
            // Random 10 pairs (Reduced from 15)
            const selection = shuffle([...vocabDB]).slice(0, 10);
            gameState.l2Data = selection;
            gameState.l2PairsLeft = 10;
            gameState.l2TimeLeft = 90; // Increased to 90s
            gameState.l2Selected = null;
            gameState.l2Lock = false;

            // Generate Cards (10 * 2 = 20 cards)
            let cards = [];
            selection.forEach(item => {
                cards.push({ id: item.id, type: 'en', text: item.en });
                cards.push({ id: item.id, type: 'ch', text: item.ch });
            });
            cards = shuffle(cards);

            const grid = document.getElementById('l2-grid');
            grid.innerHTML = "";
            cards.forEach(card => {
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-lg shadow-md border-2 border-gray-100 flex items-center justify-center text-center cursor-pointer h-24 font-bold text-sm select-none active:scale-95 transition";
                el.innerText = card.text;
                el.dataset.id = card.id;
                el.dataset.type = card.type; // en or ch
                el.onclick = () => handleCardClick(el);
                grid.appendChild(el);
            });

            document.getElementById('l2-remaining').innerText = 10;
            document.getElementById('l2-time-text').innerText = 90;
            document.getElementById('l2-timer-bar').style.width = '100%';

            // Start Timer
            if (gameState.l2Timer) clearInterval(gameState.l2Timer);
            gameState.l2Timer = setInterval(() => {
                gameState.l2TimeLeft--;
                document.getElementById('l2-time-text').innerText = gameState.l2TimeLeft;
                const pct = (gameState.l2TimeLeft / 90) * 100;
                document.getElementById('l2-timer-bar').style.width = `${pct}%`;

                if (gameState.l2TimeLeft <= 0) {
                    clearInterval(gameState.l2Timer);
                    endLevel2(false); // Time out
                }
            }, 1000);
        }

        function handleCardClick(el) {
            // Prevent clicking locked, matched, or already selected
            if (gameState.l2Lock || el.style.display === 'none' || el.classList.contains('card-selected')) return;

            el.classList.add('card-selected');

            if (!gameState.l2Selected) {
                // First card
                gameState.l2Selected = el;
            } else {
                // Second card
                const first = gameState.l2Selected;
                gameState.l2Lock = true;

                if (first.dataset.id === el.dataset.id && first.dataset.type !== el.dataset.type) {
                    // Match!
                    setTimeout(() => {
                        // REMOVE LOGIC: Set display none to fill gap
                        first.style.display = 'none';
                        el.style.display = 'none';
                        
                        first.classList.remove('card-selected');
                        el.classList.remove('card-selected');
                        
                        gameState.l2PairsLeft--;
                        document.getElementById('l2-remaining').innerText = gameState.l2PairsLeft;
                        gameState.l2Selected = null;
                        gameState.l2Lock = false;

                        if (gameState.l2PairsLeft === 0) {
                            clearInterval(gameState.l2Timer);
                            endLevel2(true);
                        }
                    }, 300);
                } else {
                    // Mismatch
                    setTimeout(() => {
                        first.classList.add('shake', 'border-red-400', 'bg-red-50');
                        el.classList.add('shake', 'border-red-400', 'bg-red-50');
                        // Remove selected styling during error shake so user knows it failed
                        first.classList.remove('card-selected');
                        el.classList.remove('card-selected');
                    }, 100);

                    setTimeout(() => {
                        first.className = first.className.replace('shake border-red-400 bg-red-50', '');
                        el.className = el.className.replace('shake border-red-400 bg-red-50', '');
                        // Add base class back just in case replace killed it, though replace string logic above is specific.
                        // Better: just remove specific error classes
                        first.classList.remove('shake', 'border-red-400', 'bg-red-50');
                        el.classList.remove('shake', 'border-red-400', 'bg-red-50');
                        
                        gameState.l2Selected = null;
                        gameState.l2Lock = false;
                    }, 800);
                }
            }
        }

        function endLevel2(finished) {
            const pairsFound = 10 - gameState.l2PairsLeft;
            const score = Math.round((pairsFound / 10) * 100);
            gameState.scores.l2 = score;

            if (score >= 80) {
                showResultScreen(true, "L2 é€šé—œï¼å‰å¾€æœ€çµ‚é—œ", () => startLevel(3));
            } else {
                showResultScreen(false, "æ™‚é–“åˆ°ï¼å®Œæˆåº¦ä¸è¶³ 80%", () => startLevel(2));
            }
        }


        // --- LEVEL 3: SPEAKING ---
        function initLevel3() {
            document.getElementById('view-level3').classList.remove('hidden');
            // Random 10
            gameState.l3Data = shuffle([...vocabDB]).slice(0, 10);
            gameState.l3Index = 0;
            gameState.l3CorrectCount = 0;
            renderLevel3Question();
        }

        function renderLevel3Question() {
            if (gameState.l3Index >= gameState.l3Data.length) {
                endLevel3();
                return;
            }

            const current = gameState.l3Data[gameState.l3Index];
            gameState.l3MistakeMade = false;

            document.getElementById('l3-progress').style.width = `${(gameState.l3Index / 10) * 100}%`;
            document.getElementById('l3-q-num').innerText = gameState.l3Index + 1;

            document.getElementById('l3-word').innerText = capitalize(current.en);
            document.getElementById('l3-meaning').innerText = current.ch;

            // Reset UI
            document.getElementById('l3-feedback').innerHTML = '<p class="text-gray-400 text-sm">è«‹æŒ‰éº¥å…‹é¢¨é–‹å§‹éŒ„éŸ³</p>';
            document.getElementById('l3-hint-btn').classList.add('hidden');
            
            const micBtn = document.getElementById('l3-mic-btn');
            micBtn.disabled = false;
            micBtn.classList.remove('bg-gray-400', 'bg-red-500', 'pulse-ring');
            micBtn.classList.add('bg-red-500');
            document.getElementById('l3-mic-icon').className = "fas fa-microphone";
        }

        function toggleL3Mic() {
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch(e) { recognition.stop(); }
            }
        }

        function playL3Hint() {
            const word = gameState.l3Data[gameState.l3Index].en;
            speak(word, 0.7);
            
            // Re-enable mic after hint
            setTimeout(() => {
                document.getElementById('l3-mic-btn').disabled = false;
                document.getElementById('l3-mic-btn').classList.remove('bg-gray-400');
                document.getElementById('l3-mic-btn').classList.add('bg-red-500');
                document.getElementById('l3-feedback').innerHTML = '<p class="text-blue-500 text-sm font-bold">å·²è½æç¤ºï¼Œè«‹å†å¿µä¸€æ¬¡</p>';
            }, 1000);
        }

        // --- SPEECH LOGIC ---
        function initSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    const btn = document.getElementById('l3-mic-btn');
                    btn.classList.add('pulse-ring', 'bg-red-600');
                    document.getElementById('l3-mic-icon').className = "fas fa-stop";
                    document.getElementById('l3-feedback').innerHTML = '<p class="text-red-500 animate-pulse font-bold">è†è½ä¸­...</p>';
                };

                recognition.onend = () => {
                    isListening = false;
                    const btn = document.getElementById('l3-mic-btn');
                    btn.classList.remove('pulse-ring');
                    document.getElementById('l3-mic-icon').className = "fas fa-microphone";
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    checkSpeaking(transcript);
                };

                recognition.onnomatch = () => {
                    document.getElementById('l3-feedback').innerHTML = '<p class="text-orange-500 font-bold"><i class="fas fa-exclamation-triangle"></i> æ”¶éŸ³ä¸æ¸…æ¥šï¼Œè«‹å†å¿µä¸€æ¬¡</p>';
                };

                recognition.onerror = (event) => {
                    if (event.error === 'no-speech') {
                         document.getElementById('l3-feedback').innerHTML = '<p class="text-orange-500 font-bold">æ²’è½åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡</p>';
                    } else {
                        console.log("Error", event.error);
                    }
                    isListening = false;
                    const btn = document.getElementById('l3-mic-btn');
                    btn.classList.remove('pulse-ring');
                };
            } else {
                alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜");
            }
        }

        function checkSpeaking(transcript) {
            const target = gameState.l3Data[gameState.l3Index].en.toLowerCase();
            let isCorrect = false;

            // Simple fuzzy logic for A1
            if (target.includes("one's")) {
                const base = target.replace("one's", "").trim();
                const parts = base.split(" ");
                if (transcript.includes(parts[0]) && transcript.includes(parts[1])) isCorrect = true;
            } else {
                 if (transcript.includes(target) || target === transcript) isCorrect = true;
                 if (target.length > 4 && Math.abs(transcript.length - target.length) < 3 && transcript.startsWith(target[0])) isCorrect = true; // Very loose for kids
            }

            if (isCorrect) {
                if(!gameState.l3MistakeMade) {
                    gameState.l3CorrectCount++;
                     document.getElementById('l3-feedback').innerHTML = `<p class="text-green-600 font-bold"><i class="fas fa-check"></i> Great! (${transcript})</p>`;
                } else {
                     document.getElementById('l3-feedback').innerHTML = `<p class="text-green-600 font-bold"><i class="fas fa-check"></i> Good job!</p>`;
                }

                setTimeout(() => {
                    gameState.l3Index++;
                    renderLevel3Question();
                }, 1500);

            } else {
                // Wrong
                gameState.l3MistakeMade = true;
                document.getElementById('l3-feedback').innerHTML = `<p class="text-red-500 font-bold">ä¸æ­£ç¢º (è½åˆ°: ${transcript})</p>`;
                
                // Show hint button and disable mic until clicked
                document.getElementById('l3-hint-btn').classList.remove('hidden');
                document.getElementById('l3-mic-btn').disabled = true;
                document.getElementById('l3-mic-btn').classList.add('bg-gray-400');
                document.getElementById('l3-mic-btn').classList.remove('bg-red-500');
            }
        }

        function endLevel3() {
            const accuracy = (gameState.l3CorrectCount / 10) * 100;
            gameState.scores.l3 = accuracy;

            if (accuracy >= 80) {
                showFinalResult();
            } else {
                showResultScreen(false, "L3 æ­£ç¢ºç‡æœªé” 80% (é¦–æ¬¡å˜—è©¦)", () => startLevel(3));
            }
        }

        // --- FINAL RESULT SCREEN ---
        function showResultScreen(isPass, msg, action) {
            const views = ['view-start', 'view-intro', 'view-level1', 'view-level2', 'view-level3', 'view-result'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById('view-result').classList.remove('hidden');
            
            // Only show relevant scores so far
            updateScoreTable();

            document.getElementById('result-user').innerText = gameState.user;
            document.getElementById('result-comment').innerText = msg;
            
            const btnContainer = document.getElementById('action-buttons');
            btnContainer.innerHTML = "";
            const btn = document.createElement('button');
            btn.className = isPass ? "w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg" : "w-full bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg";
            btn.innerText = isPass ? "ä¸‹ä¸€é—œ / å®Œæˆ" : "é‡æ–°æŒ‘æˆ°æœ¬é—œ";
            btn.onclick = action;
            btnContainer.appendChild(btn);
        }

        function showFinalResult() {
            showResultScreen(true, "æ­å–œå®Œæˆæ‰€æœ‰æŒ‘æˆ°ï¼è«‹æˆªåœ–ç¹³äº¤ã€‚", null);
            
            // Generate Teacher Comment
            const avg = (gameState.scores.l1 + gameState.scores.l2 + gameState.scores.l3) / 3;
            let comment = "";
            if (avg >= 95) comment = "å¤ªå¼·äº†ï¼ä½ æ˜¯è‹±æ–‡å–®å­—ç‹ï¼ğŸ‘‘";
            else if (avg >= 90) comment = "Excellent! ç™¼éŸ³æ¨™æº–ï¼Œåæ‡‰è¶…å¿«ï¼ğŸ”¥";
            else if (avg >= 80) comment = "Very Good! ç©©ç´®ç©©æ‰“ï¼Œè¡¨ç¾å¾ˆæ£’ï¼ğŸ‘";
            else comment = "Good job! é †åˆ©é€šé—œï¼Œç¹¼çºŒä¿æŒï¼ğŸ’ª";

            document.getElementById('result-comment').innerText = comment;
            document.getElementById('result-comment').classList.add('text-lg');

            // Hide the button, show screenshot hint
            document.getElementById('action-buttons').innerHTML = `
                <div class="mt-4 text-center">
                    <p class="text-red-500 font-bold animate-pulse text-sm mb-4"><i class="fas fa-camera"></i> è«‹ç¾åœ¨æˆªåœ–æ­¤ç•«é¢ç¹³äº¤ä½œæ¥­</p>
                    <button onclick="location.reload()" class="text-gray-400 underline text-sm">å›åˆ°é¦–é </button>
                </div>
            `;
        }

        function updateScoreTable() {
            document.getElementById('score-l1').innerText = gameState.scores.l1 > 0 ? gameState.scores.l1 + "%" : "--";
            document.getElementById('score-l2').innerText = gameState.scores.l2 > 0 ? gameState.scores.l2 + "%" : "--";
            document.getElementById('score-l3').innerText = gameState.scores.l3 > 0 ? gameState.scores.l3 + "%" : "--";
        }

        // --- UTILS ---
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function speak(text, rate = 0.8) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = rate;
            window.speechSynthesis.speak(utterance);
        }

        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    </script>
</body>
</html>